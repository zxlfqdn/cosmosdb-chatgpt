@using Cosmos.Chat.GPT.Constants
@using Cosmos.Chat.GPT.Services
@using System.Security.Claims
@inject ChatService chatService
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider


<div class="h-100 d-flex flex-column" style="min-width: 275px;">

    <div class="flex-column navbar navbar-dark bg-black">
        <div class="container-fluid justify-content-between">
            <div class="flex-fill">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="80"
                    viewBox="0 0 174 85" fill="none">
                    <rect width="174" height="85" fill="url(#pattern0)" />
                    <defs>
                        <pattern id="pattern0" patternContentUnits="objectBoundingBox" width="1" height="1">
                            <use xlink:href="#image0_1_2" transform="scale(0.00574713 0.0117647)" />
                        </pattern>
                        <image id="image0_1_2" width="174" height="85"
                            xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAABVCAYAAADQWd80AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo0RTRCNEE3RTE2QzNFQTExOUIxMkU1ODg3OUZGQ0MyNyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoxNkRBOTlFREMzMTcxMUVBODhGOUI5MUE2OUI0MEFBMyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoxNkRBOTlFQ0MzMTcxMUVBODhGOUI5MUE2OUI0MEFBMyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChXaW5kb3dzKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjRGNEI0QTdFMTZDM0VBMTE5QjEyRTU4ODc5RkZDQzI3IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjRFNEI0QTdFMTZDM0VBMTE5QjEyRTU4ODc5RkZDQzI3Ii8+IDwvcmRmOkRlc2NyaXB0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" />
                    </defs>
                </svg>
                @* <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" height="30" fill="currentColor" class="text-light">
                    <path d="M422 250a169 169 0 0 1-50 121c-11 11-22 20-35 27-13 8-27 14-41 18a169 169 0 0 1-152-31 303 303 0 0 1-89 15 63 63 0 0 1-37-12c-5-5-10-9-13-15s-5-12-5-19c0-11 3-21 8-32s12-21 20-31l26-29 25-23a168 168 0 0 1 53-114 166 166 0 0 1 118-47c25 0 50 5 73 16a721 721 0 0 1 85-24l29-2 22 2c8 2 14 4 21 8 6 3 11 8 14 14 4 6 6 13 6 22 0 11-3 21-8 32s-13 22-21 32a294 294 0 0 1-50 52v10l1 10zm-65-134a172 172 0 0 1 55 78l16-15a274 274 0 0 0 34-44c5-7 7-14 7-20 0-4-1-7-4-9l-8-4-11-2h-9c-14 0-27 1-41 4l-39 12zM62 369c9 0 19-1 28-3l28-6a163 163 0 0 1-37-80 284 284 0 0 0-44 54c-4 7-6 14-6 19 0 4 1 7 3 9l9 4 10 2 9 1zm89-19a789 789 0 0 0 236-133 134 134 0 0 0-50-77c-12-9-26-17-40-23s-31-8-47-8a137 137 0 0 0-99 42 137 137 0 0 0-41 99 139 139 0 0 0 41 100zm239-96c-64 49-133 89-208 118a131 131 0 0 0 68 19 137 137 0 0 0 97-40 145 145 0 0 0 43-97zM0 63c0-4 1-7 3-9s5-3 9-3a39 39 0 0 0 21-7l9-7c3-3 5-6 6-10l1-5 1-7 1-5 1-3c1-3 2-4 4-5 2-2 4-2 7-2 4 0 7 1 8 4s3 5 3 9l2 11 5 10 8 8c2 3 6 5 9 6l6 1 6 1a70 70 0 0 1 8 2l5 4 2 6c0 4-1 7-4 9-2 2-5 3-9 3a36 36 0 0 0-21 6l-8 8c-2 3-5 6-6 10l-2 10-2 10-4 5-7 2c-3 0-6-2-8-4s-3-4-3-8a40 40 0 0 0-7-21l-7-9c-3-3-6-5-10-6-3-2-7-2-11-3l-9-1c-3-1-4-3-5-5l-2-5zm500 375c0 3-1 5-3 7l-7 3-9 2a30 30 0 0 0-14 6l-7 4a43 43 0 0 0-11 28v3l-1 2-4 5-6 2c-4 0-7-1-9-3s-3-5-3-9l-3-15-8-12a38 38 0 0 0-29-12c-3 0-5-1-7-3-3-3-4-5-4-9 0-3 1-6 3-7l7-4 9-1 8-2 6-4 6-5c5-3 7-8 9-13l3-15c0-3 1-6 4-8 2-2 4-3 8-3 3 0 6 1 7 3l3 7 2 8 2 8 4 7c1 3 3 5 5 6 4 4 8 7 12 8l13 4 10 3c3 1 4 4 4 9z"/>
                </svg> *@
                @* <i class="bi bi-plus text-light"></i> *@
                @* <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" height="30" fill="currentColor" class="text-light">
                    <path d="M415.98 265.82v-.27a17.24 17.24 0 1 0 .01.27ZM224.4 321.87a17.24 17.24 0 1 0 34.48 0 17.24 17.24 0 0 0-34.48 0Z"/>
                    <path d="M397.92 209.51C395.91 95.77 266.41 51.59 182.48 96.66l-.12 145.45a5.39 5.39 0 0 0 5.39 5.39h41.76a18.85 18.85 0 0 1 18.86 18.86v25.6a29.36 29.36 0 1 1-36.1 28.56 29.1 29.1 0 0 1 22.9-28.56v-26.94a5.65 5.65 0 0 0-5.66-5.66h-41.76a18.59 18.59 0 0 1-18.59-18.59v-135.9c-21.08 14.76-38.2 36.03-47.96 64.23-163.09 22.89-139.5 256.6 22.91 252.74h14.81V305.98a5.39 5.39 0 0 0-5.39-5.39h-23.71a29.36 29.36 0 1 1 0-13.2h23.71a18.59 18.59 0 0 1 18.59 18.59v115.86h148.46V210.59a5.39 5.39 0 0 0-5.39-5.39h-28.83a29.36 29.36 0 1 1-28.56-36.1 29.1 29.1 0 0 1 28.56 22.9h27.75a18.59 18.59 0 0 1 18.59 18.59v94.84h53.89a5.66 5.66 0 0 0 5.66-5.66v-5.39a29.38 29.38 0 0 1 6.73-57.94l1.1-.02a29.37 29.37 0 0 1 29.35 29.39 29.36 29.36 0 0 1-22.9 28.56v5.39a18.85 18.85 0 0 1-18.86 18.86h-53.89v103.2h43.38c61.49 2.64 114.03-46.08 115.32-107.78-1.2-53.49-41.47-98-94.58-104.54Z"/>
                    <circle cx="101" cy="293.85" r="17.24"/>
                    <circle cx="257.81" cy="198.46" r="17.24"/>
                    <path d="m182.49 96.66-.07.05.07-.04Z"/>
                </svg> *@
            </div>
            <button class="navbar-toggler border-0" @onclick="ToggleNavMenu">
                <i class="bi bi-arrow-right-square-fill"></i>
            </button>
        </div>
    </div>

    <div class="flex-grow-1 flex-column justify-content-center overflow-y-auto overflow-x-hidden">
        @if (_loadingComplete == true)
        {
                                    <div style="font-family: 'Meiryo UI';">
                                        <nav class="flex-column">
                                            <div class="nav-item py-2 d-grid">
                                                <NavLink style="cursor:pointer" class="btn mx-1 btn-outline-info d-flex flex-row align-items start" Match="NavLinkMatch.All" @onclick="@(e => NewChat())">
                                                    <style>
                                                        .btn-outline-info {color: rgb(56, 3, 71); border-color: rgb(56, 3, 71); border-width: 2px; font-weight: bold;}
                                                        .btn-outline-info:hover {background-color: rgb(56, 3, 71); border-color: rgb(56, 3, 71); color: white;}
                                                    </style>
                                                    <i class="bi bi-plus" style="font-weight: bold;"></i>
                                                    <span class="flex-fill">
                                                        新しいチャット作成
                                                    </span>
                                                </NavLink>
                                            </div>
                                            <div class="row row-cols-1 g-2 px-2 d-flex flex-column align-items-start">
                        @foreach (var session in ChatSessions)
                        {
                                                                            <div class="col">
                                                                                <div class="card @(IsActiveSession(session.SessionId) ? "bg-black text-light" : "bg-black opacity-50 text-light")">
                                                                                    <div class="card-body user-select-none" role="button" @onclick="@(e => LoadChat(session.SessionId,session.Name, session.TokensUsed))">
                                                                                        <a class="card-title text-decoration-none h6">
                                            @* @if (IsActiveSession(session.SessionId))
                                            {
                                                <i class="bi bi-chat-right-dots-fill me-2"></i>
                                            } *@
                                                                                            <span title="@session.Name" class="ms-1">                                                
                                                @{
                                                    string substring = SafeSubstring(session.Name, 20);
                                                    MarkupString html = new MarkupString(substring);
                                                }
                                                @html
                                                                                            </span>
                                                                                        </a>
                                                                                        <div class="d-flex justify-content-end">
                                                                                        <div class="btn-group" role="group">
                                                                                            <button type="button" class="btn btn-sm btn-link text-light" @onclick="@(e => OpenInput(session.SessionId,session.Name))">
                                                                                                <i class="bi bi-pencil-fill me-1"></i>
                                                                                            </button>
                                                                                            <button type="button" class="btn btn-sm btn-link text-light" @onclick="@(e => OpenConfirmation(session.SessionId,session.Name))">
                                                                                                <i class="bi bi-trash-fill ms-1"></i>
                                                                                            </button>
                                                                                        </div>
                                                                                        </div>
                                                                                    </div>
                                    @* <div class="card-footer d-flex align-items-center justify-content-between">
                                        <span class="badge bg-light me-2 user-select-none">
                                            Tokens Used: @session.TokensUsed
                                        </span>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-link text-light" @onclick="@(e => OpenInput(session.SessionId,session.Name))">
                                                <i class="bi bi-pencil-fill me-1"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-link text-light" @onclick="@(e => OpenConfirmation(session.SessionId,session.Name))">
                                                <i class="bi bi-trash-fill ms-1"></i>
                                            </button>
                                        </div>
                                    </div> *@
                                                                                </div>
                                                                            </div>
                        }
                                            </div>
                                        </nav>
                                    </div>
        }
    </div>
</div>



@if (_deletePopUpOpen)
{
                            <Confirmation Caption="チャット削除"
                                Message="@_popUpText"
                                OnClose="@OnConfirmationClose"
                                Type="Confirmation.Category.DeleteNot">
                            </Confirmation>
}


@if (_renamePopUpOpen)
{
                            <Input Caption="チャット名変更"
                                Value="@_popUpText"
                                OnClose="@OnInputClose" >
                            </Input>
}


@code {

    [Parameter]
    public EventCallback<Session> OnChatClicked { get; set; } = default!;

    [Parameter]
    public static List<Session> ChatSessions { get; set; } = new();

    [Parameter]
    public EventCallback OnNavBarVisibilityUpdated { get; set; }

    [Parameter]
    public EventCallback OnThemeUpdated { get; set; }

    private string? _sessionId;
    private string? _popUpText;
    private bool _deletePopUpOpen = false;
    private bool _loadingComplete;
    private bool _renamePopUpOpen = false;

    public Session? CurrentSession;

    private static event EventHandler<string>? OnNavMenuChanged;

    private string userId = "12345";
    private IEnumerable<Claim> claims = Enumerable.Empty<Claim>();

    protected override async Task OnInitializedAsync()
    {
        var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authenticationState.User;
        if (user is null)
        {
            userId = "noUser";
        }
        else
        {
            if (user.Identity is null)
            {
                userId = "noIdentity";
            }
            else
            {
                if (!user.Identity.IsAuthenticated)
                {
                    userId = "noIsAuthenticated";
                }
                else
                {
                    claims = user.Claims;
                    if (claims is null)
                    {
                        userId = "noClaims";
                    }
                    else
                    {
                        userId = user.FindFirst(c => c.Type == ClaimTypes.Surname)?.Value;
                    }
                }
            }
        }

    }

    async private Task ToggleNavMenu()
    {
        await OnNavBarVisibilityUpdated.InvokeAsync();
    }

    async private Task ChangeTheme()
    {
        await OnThemeUpdated.InvokeAsync();
    }

    protected override void OnInitialized()
    {
        OnNavMenuChanged += async (o, e) =>
        {
            await this.InvokeAsync(async () =>
            {
                this.StateHasChanged();
                await LoadCurrentChatAsync();
            });
        };
    }

    private void OpenConfirmation(string id, string title)
    {
        _deletePopUpOpen = true;
        _sessionId = id;
        _popUpText = $"\"{title}\" このチャットを削除してよろしいですか？";
    }

    public void UpdateNavMenuDisplay(string reason = "")
    {
        if (OnNavMenuChanged is not null)
        {
            OnNavMenuChanged.Invoke(null, reason);
        }
    }

    private async Task OnConfirmationClose(bool isOk)
    {
        bool updateCurrentChat = false;

        if (CurrentSession is not null & _sessionId == CurrentSession?.SessionId)
            updateCurrentChat = true;

        if (isOk)
        {
            _deletePopUpOpen = false;
            await chatService.DeleteChatSessionAsync(_sessionId);

            _deletePopUpOpen = false;

            UpdateNavMenuDisplay("Delete");

            if (!updateCurrentChat)
                return;

            CurrentSession = new Session();
            CurrentSession.SessionId = Interface.EMPTY_SESSION;
            CurrentSession.Name = string.Empty;

            if (ChatSessions is not null & ChatSessions?.Count > 0)
            {
                var match = ChatSessions?.FirstOrDefault();
                if (match is not null)
                {
                    CurrentSession.SessionId = match.SessionId;
                    CurrentSession.Name = match.Name;
                    CurrentSession.TokensUsed = match.TokensUsed;
                }
            }

            await LoadCurrentChatAsync();
        }

        _deletePopUpOpen = false;
    }

    private void OpenInput(string id, string title)
    {
        _renamePopUpOpen = true;
        _sessionId = id;
        _popUpText = title;
    }

    private async Task OnInputClose(string newName)
    {
        if (newName != "")
        {
            bool updateCurrentChat = false;

            if (_sessionId == CurrentSession?.SessionId)
            {
                updateCurrentChat = true;
            }

            await chatService.RenameChatSessionAsync(_sessionId, newName);

            _renamePopUpOpen = false;

            UpdateNavMenuDisplay("Rename");

            if (!updateCurrentChat)
            {
                return;
            }

            if (CurrentSession is not null)
            {
                CurrentSession.Name = newName;
            }
            await LoadCurrentChatAsync();
        }

        _renamePopUpOpen = false;
    }

    private async Task NewChat()
    {
        await chatService.CreateNewChatSessionAsync(userId);

        if (ChatSessions.Count == 1)
        {
            CurrentSession = ChatSessions[0] with { };
            await LoadCurrentChatAsync();
        }

        UpdateNavMenuDisplay("Add");
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_loadingComplete == true)
            return;

        _loadingComplete = false;

        ChatSessions = await chatService.GetAllChatSessionsAsync(userId);
        if (CurrentSession is not null && ChatSessions is not null & ChatSessions?.Count > 0)
        {
            var match = ChatSessions?.FirstOrDefault();
            if (match is not null)
            {
                CurrentSession.SessionId = match.SessionId;
                CurrentSession.Name = match.Name;
                CurrentSession.TokensUsed = match.TokensUsed;
            }
        }

        _loadingComplete = true;
        await LoadCurrentChatAsync();

    }

    private async Task<int> LoadCurrentChatAsync()
    {
        int index = 0;
        if (CurrentSession is not null & ChatSessions is not null & ChatSessions?.Count > 0)
        {
            index = ChatSessions?.FindIndex(s => s.SessionId == CurrentSession?.SessionId) ?? 0;
        }
        if (CurrentSession is null || index < 0)
        {
            CurrentSession = new Session();
            CurrentSession.SessionId = Interface.EMPTY_SESSION;
            CurrentSession.Name = string.Empty;

            if (ChatSessions is not null & ChatSessions?.Count > 0)
            {
                var match = ChatSessions?.FirstOrDefault();
                if (match is not null)
                {
                    CurrentSession.SessionId = match.SessionId;
                    CurrentSession.Name = match.Name;
                    CurrentSession.TokensUsed = match.TokensUsed;
                }
            }
        }

        await OnChatClicked.InvokeAsync(CurrentSession);

        return 0;
    }

    async private Task<int> LoadChat(string _sessionId, string sessionName, int? tokensUsed)
    {
        if (ChatSessions is null) return 0;

        if (CurrentSession is null)
            CurrentSession = new Session();

        CurrentSession.SessionId = _sessionId;
        CurrentSession.Name = sessionName;
        CurrentSession.TokensUsed = tokensUsed;

        await LoadCurrentChatAsync();

        return 0;
    }

    private bool IsActiveSession(string _sessionId) => CurrentSession switch
    {
        null => true,
        (Session s) when s.SessionId == _sessionId => true,
        _ => false
    };

    public string SafeSubstring(string text, int maxLength) => text switch
    {
        null => string.Empty,
        _ => text.Length > maxLength ? text.Substring(0, maxLength) + "..." : text
    };
}